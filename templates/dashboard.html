{% extends "base.html" %}

{% block title %}Dashboard{% endblock %}

{% block content %}

<h2 style="color:white; margin-bottom:20px;">Welcome, {{ current_user.shop_name }}</h2>

<!-- Rate update section for current user -->
<div class="rate-update-section" style="margin:20px auto; padding:20px; border:1px solid #ccc; border-radius:15px; background-color:transparent; max-width:800px; width:90%; display:flex; flex-wrap:wrap; justify-content:space-around; gap:20px;">
  <div style="flex:1; min-width:280px; text-align:center;">
    <h3 style="margin-bottom:15px; color:white; font-size:18px;">
      Your Gold Rate: <span id="currentGoldRate" style="color:green;">{{ "%.2f"|format(current_gold_rate) }}</span> NPR/tola
    </h3>
    <input type="number" id="goldRateInput" placeholder="Enter new gold rate" step="0.01"
           style="width:100%; padding:10px; font-size:16px; border-radius:8px; border:1px solid #ccc; box-sizing:border-box; outline:none; margin-bottom:10px;">
    <button class="btn" onclick="updateGoldRate()"
            style="padding:10px 0; font-size:16px; border-radius:8px; background-color:#28a745; color:white; border:none; cursor:pointer; width:100%;">
      Update Gold Rate
    </button>
    <p id="goldRateMessage" style="margin-top:8px; color:green; font-weight:500;"></p>
  </div>
  <div style="flex:1; min-width:280px; text-align:center;">
    <h3 style="margin-bottom:15px; color:white; font-size:18px;">
      Your Silver Rate: <span id="currentSilverRate" style="color:green;">{{ "%.2f"|format(current_silver_rate) }}</span> NPR/tola
    </h3>
    <input type="number" id="silverRateInput" placeholder="Enter new silver rate" step="0.01"
           style="width:100%; padding:10px; font-size:16px; border-radius:8px; border:1px solid #ccc; box-sizing:border-box; outline:none; margin-bottom:10px;">
    <button class="btn" onclick="updateSilverRate()"
            style="padding:10px 0; font-size:16px; border-radius:8px; background-color:#007bff; color:white; border:none; cursor:pointer; width:100%;">
      Update Silver Rate
    </button>
    <p id="silverRateMessage" style="margin-top:8px; color:green; font-weight:500;"></p>
  </div>
</div>

<div class="toolbar" style="display:flex; flex-wrap:wrap; gap:10px; margin-bottom:20px;">
  <a class="btn" href="{{ url_for('add_jewelry') }}" style="flex:1; text-align:center;">+ Add Jewelry</a>
  <a class="btn outline" href="{{ url_for('search') }}" style="flex:1; text-align:center;">Search by ID</a>
  <a class="btn outline" href="{{ url_for('sold_history') }}" style="flex:1; text-align:center;">View Sold History</a>
</div>

<h3>Your Unsold Jewelry</h3>
{% if items %}
<div class="table-wrapper">
<table class="table">
  <thead>
    <tr>
      <th>ID</th><th>Material</th><th>Weight (Tola)</th><th>Labor</th><th>Added</th><th>Photo</th><th>Invoice</th><th>Action</th>
    </tr>
  </thead>
  <tbody>
    {% for it in items %}
    <tr>
      <td data-label="ID">{{ it.formatted_id }}</td>
      <td data-label="Material">{{ it.material_type | capitalize }}</td>
      <td data-label="Weight (Tola)">{{ "%.2f"|format(it.weight_tola) }}</td>
      <td data-label="Labor">{{ "%.2f"|format(it.labor_cost) }}</td>
      <td data-label="Added">{{ it.created_at.strftime("%Y-%m-%d %H:%M") }}</td>
      <td data-label="Photo">
        {% if it.photo_path %}
          <img src="/{{ it.photo_path }}" alt="photo" class="thumb" style="max-width:60px; max-height:60px; object-fit:cover; border-radius:8px;">
        {% else %}-{% endif %}
      </td>
      <td data-label="Invoice"><a class="btn small" href="{{ url_for('invoice', item_id=it.id) }}" target="_blank">Open</a></td>
      <td data-label="Action">
        <form method="post" action="{{ url_for('mark_sold', item_id=it.id) }}" style="display:inline;">
          <button type="submit" class="btn small success">Mark Sold</button>
        </form>
      </td>
    </tr>
    {% endfor %}
  </tbody>
</table>
</div>
{% else %}
<p>No unsold items yet. Add your first jewelry.</p>
{% endif %}

<script>
function updateGoldRate() {
    let rate = document.getElementById("goldRateInput").value;
    if (!rate) {
        showCustomAlert("Enter a gold rate first!");
        return;
    }
    fetch("/update-gold-rate", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ rate: rate })
    })
    .then(res => res.json())
    .then(data => {
        const msg = data.message || data.error;
        document.getElementById("goldRateMessage").textContent = msg;
        if (data.message) {
            document.getElementById("currentGoldRate").textContent = parseFloat(rate).toFixed(2);
        }
    })
    .catch(err => {
        document.getElementById("goldRateMessage").textContent = "Error updating gold rate.";
        console.error(err);
    });
}

function updateSilverRate() {
    let rate = document.getElementById("silverRateInput").value;
    if (!rate) {
        showCustomAlert("Enter a silver rate first!");
        return;
    }
    fetch("/update-silver-rate", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ rate: rate })
    })
    .then(res => res.json())
    .then(data => {
        const msg = data.message || data.error;
        document.getElementById("silverRateMessage").textContent = msg;
        if (data.message) {
            document.getElementById("currentSilverRate").textContent = parseFloat(rate).toFixed(2);
        }
    })
    .catch(err => {
        document.getElementById("silverRateMessage").textContent = "Error updating silver rate.";
        console.error(err);
    });
}

function showCustomAlert(message) {
    let alertModal = document.getElementById('customAlertDialog');
    if (!alertModal) {
        alertModal = document.createElement('div');
        alertModal.id = 'customAlertDialog';
        alertModal.style.cssText = `
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background-color: white; padding: 20px; border-radius: 10px; box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            z-index: 1000; text-align: center; width: 300px; max-width: 90%; color: black;
        `;
        alertModal.innerHTML = `
            <p id="customAlertMessage" style="margin-bottom: 20px;"></p>
            <button onclick="document.getElementById('customAlertDialog').style.display='none'"
                    style="padding: 10px 20px; background-color: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer;">
                OK
            </button>
        `;
        document.body.appendChild(alertModal);
    }
    document.getElementById('customAlertMessage').textContent = message;
    alertModal.style.display = 'block';
}
</script>

{% endblock %}
